---
layout: post
title: "linux下双网卡配置"
date: 2013-05-14 01:09
comments: true
categories: tools
tags: [linux, 双网卡]
---

**需求**： 一台PC1拥有双网卡，另外一台PC2需要通过这台pc上网。

<img src="http://images.cnblogs.com/cnblogs_com/billowkiller/447098/r_ac345982b2b7d0a207325429cbef76094a369a8e.jpg" alt="网络拓扑图"/>

**配置过程**：

首先需要配置pc1的两个网卡信息以及pc2的网卡信息。这个比较简单，接下里需要配置pc1中的静态路由。

文件ipt.save表示静态路由表的修改文件。

    # Generated by iptables-save v1.4.2 on Wed Nov 16 15:04:23 2011
     *filter
     :INPUT ACCEPT [203:29797]
     :FORWARD ACCEPT [0:0]
     :OUTPUT ACCEPT [83:10885]
     COMMIT
     # Completed on Wed Nov 16 15:04:23 2011
     # Generated by iptables-save v1.4.2 on Wed Nov 16 15:04:23 2011
     *nat
     :PREROUTING ACCEPT [82:12935]
     :POSTROUTING ACCEPT [25:1724]
     :OUTPUT ACCEPT [25:1724]
     -A POSTROUTING -s 10.0.0.0/8 ! -d 10.0.0.0/8 -j MASQUERADE 
     COMMIT
     # s->source !d->not distination->not in the same subset
     # Completed on Wed Nov 16 15:04:23 2011

进入root权限后，执行命令

    iptables-restore /home/angel/net_scripts/ipt.save

这样就是修改了静态路由表，但还需要将转发开关打开，需要命令如下

    echo '1' > /proc/sys/net/ipv4/ip_forward

这样修改之后pc2就可以通过pc1上网了。
<!--more-->
但是重启后发现**两个问题**：

-   linux下如果有两个网卡eth0和eth1，系统启动时候会先启动eth0，后启动eth1，这样造成eth0的信息被eth1覆盖。
-   以上的两个命令并不是永久的，重启后失效。

第一个问题的解决方案是修改/etc/network/interfaces
文件，修改网卡接口的信息，修改后的文件如下：

    # interfaces(5) file used by ifup(8) and ifdown(8)
     auto lo
     iface lo inet loopback
     
     auto eth1
     iface eth1 inet dhcp
     
     auto eth0
     iface eth0 inet static
     address 10.0.0.1
     netmask 255.0.0.0
     broadcast 10.255.255.255

需要重启生效，也可以使用命令

    sudo /etc/init.d/networking restart

第二个问题可以写一个简单的脚本iptable.sh来实现，每次开机启动自动执行脚本：

    iptables-restore /home/angel/net_scripts/ipt.save
     echo '1' > /proc/sys/net/ipv4/ip_forward

将脚本放在任意的位置，如下放入home文件夹下，修改/etc/rc.local文件：

    #!/bin/sh -e
     #
     # rc.local
     #
     # This script is executed at the end of each multiuser runlevel.
     # Make sure that the script will "exit 0" on success or any other
     # value on error.
     #
     # In order to enable or disable this script just change the execution
     # bits.
     #
     # By default this script does nothing.
     sh /home/bk/iptable.sh
     exit 0

这样每次启动都会调用脚本，并且使用root权限。
